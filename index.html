<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Tienda...</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para leer CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos base y la fuente del precio */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }

        /* Formato de precio exacto de la imagen */
        .precio-custom {
            color: #2c5282; /* Azul similar a la imagen */
            font-weight: 500;
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: opacity 0.2s;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
    </style>
</head>
<body>

    <!-- Pantalla de Carga -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-gray-500">Cargando catálogo...</p>
    </div>

    <!-- Navegación -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex-shrink-0 flex items-center">
                    <h1 id="store-title" class="text-2xl font-bold text-gray-800">Mi Tienda</h1>
                </div>
                <div class="relative cursor-pointer" onclick="toggleCart()">
                    <i data-lucide="shopping-cart" class="w-7 h-7 text-gray-700"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">0</span>
                </div>
            </div>
        </div>
        <!-- Categorías -->
        <div class="bg-gray-50 overflow-x-auto whitespace-nowrap border-t border-gray-200 py-2 px-4" id="category-container">
            <!-- Botones de categoría insertados dinámicamente -->
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Productos renderizados aquí -->
        </div>
    </main>

    <!-- Modal del Carrito -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="toggleCart()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg pointer-events-auto">
                    
                    <!-- Header Modal -->
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Tu Carrito</h3>
                        <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-500">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Body Modal -->
                    <div class="px-4 py-5 sm:p-6 max-h-[60vh] overflow-y-auto">
                        <div id="cart-items" class="space-y-4">
                            <!-- Items del carrito -->
                            <p class="text-center text-gray-500 py-4">El carrito está vacío</p>
                        </div>
                        
                        <div class="mt-6 border-t pt-4">
                            <div class="flex justify-between text-lg font-bold text-gray-900 mb-4">
                                <span>Total</span>
                                <span id="cart-total">$ 0.00</span>
                            </div>

                            <!-- Formulario de Cliente -->
                            <form id="checkout-form" class="space-y-3" onsubmit="processCheckout(event)">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                    <input type="text" id="customer-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                                    <input type="tel" id="customer-phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Dirección de Entrega</label>
                                    <textarea id="customer-address" required rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"></textarea>
                                </div>
                                
                                <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg mt-4 flex items-center justify-center gap-2">
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                    Enviar Pedido por WhatsApp
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Principal -->
    <script>
        // CONFIGURACIÓN INICIAL
        // Lee el archivo local 'datos_tienda.csv' ubicado en la raíz del repositorio
        const CSV_LOCAL_FILE = "./datos_tienda.csv";
        
        // ESTADO DE LA APLICACIÓN
        let storeConfig = {};
        let products = [];
        let categories = new Set();
        let cart = [];
        let currentCategory = 'Todos';

        // INICIALIZACIÓN
        window.onload = function() {
            lucide.createIcons();
            
            // Cargar CSV local
            Papa.parse(CSV_LOCAL_FILE, {
                download: true,
                header: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.warn("Error cargando CSV local. Asegúrate de que estás sirviendo esto desde un servidor (http/https) y no directamente desde el sistema de archivos (file://)", err);
                    useDummyData();
                }
            });
        };

        function useDummyData() {
            // Datos simulados por si falla la carga local (ej. CORS en local file system)
            const dummyData = [
                {
                    "Tienda_Nombre": "Tienda Demo", "Tienda_Color_1": "#0ea5e9", "Tienda_Moneda": "MXN", "Tienda_Prefijo": "52", "Tienda_Telefono": "5512345678",
                    "Prod_Categoria": "Demo", "Prod_Nombre": "Producto Ejemplo", "Prod_Precio": "100.00", "Prod_Imagen": "", "Prod_Descripcion": "Descripción de prueba.", 
                    "Prod_Variantes": "Color:Rojo,Azul|Talla:M,L"
                }
            ];
            processData(dummyData);
        }

        function processData(data) {
            if (!data || data.length === 0) return;

            const firstRow = data[0];
            storeConfig = {
                name: firstRow.Tienda_Nombre || "Mi Tienda",
                desc: firstRow.Tienda_Descripcion || "",
                phone: firstRow.Tienda_Telefono || "",
                prefix: firstRow.Tienda_Prefijo || "52",
                currency: firstRow.Tienda_Moneda || "MXN",
                color1: firstRow.Tienda_Color_1 || "#2563eb",
                color2: firstRow.Tienda_Color_2 || "#1e40af"
            };

            document.title = storeConfig.name;
            document.getElementById('store-title').innerText = storeConfig.name;
            document.documentElement.style.setProperty('--primary-color', storeConfig.color1);
            document.documentElement.style.setProperty('--secondary-color', storeConfig.color2);

            products = data.filter(row => row.Prod_Nombre && row.Prod_Precio).map((row, index) => {
                categories.add(row.Prod_Categoria);
                return {
                    id: index,
                    category: row.Prod_Categoria,
                    name: row.Prod_Nombre,
                    desc: row.Prod_Descripcion,
                    price: parseFloat(row.Prod_Precio.replace(/[^0-9.]/g, '')),
                    image: row.Prod_Imagen,
                    variants: parseVariants(row.Prod_Variantes)
                };
            });

            renderCategories();
            renderProducts();
            document.getElementById('loading').style.display = 'none';
        }

        // Parsea la cadena de variantes: "Color:Rojo=img1.jpg,Azul|Talla:S,M"
        function parseVariants(variantStr) {
            if (!variantStr) return [];
            
            // Paso 1: Separar grupos (ej: Color y Talla) con PIPE |
            const groups = variantStr.split('|');
            
            return groups.map(group => {
                const parts = group.split(':');
                if (parts.length < 2) return null;

                const label = parts[0].trim(); // "Color" o "Talla"
                const optionsRaw = parts[1].split(',');
                
                const options = optionsRaw.map(opt => {
                    const [val, img] = opt.split('=');
                    return { 
                        name: val.trim(), 
                        image: img ? img.trim() : null 
                    };
                });
                return { label, options };
            }).filter(g => g !== null);
        }

        function renderCategories() {
            const container = document.getElementById('category-container');
            let html = `<button onclick="filterCategory('Todos')" class="cat-btn inline-block px-4 py-2 mr-2 rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm font-medium transition-colors border-2 border-transparent active-cat">Todos</button>`;
            
            categories.forEach(cat => {
                html += `<button onclick="filterCategory('${cat}')" class="cat-btn inline-block px-4 py-2 mr-2 rounded-full bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-sm font-medium transition-colors">${cat}</button>`;
            });
            container.innerHTML = html;
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderProducts();
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.innerText === cat) {
                    btn.classList.add('bg-gray-800', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-700', 'bg-gray-200');
                } else {
                    btn.classList.remove('bg-gray-800', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                }
            });
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            const filtered = currentCategory === 'Todos' 
                ? products 
                : products.filter(p => p.category === currentCategory);

            filtered.forEach(p => {
                let variantSelectors = '';
                if (Array.isArray(p.variants) && p.variants.length > 0) {
                    variantSelectors = p.variants.map((v, idx) => `
                        <div class="mt-3">
                            <label class="text-xs text-gray-500 font-bold uppercase">${v.label}:</label>
                            <select id="var-select-${p.id}-${idx}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border bg-white" onchange="changeProductImage(${p.id}, this)">
                                ${v.options.map(opt => `<option value="${opt.name}" data-img="${opt.image || ''}">${opt.name}</option>`).join('')}
                            </select>
                        </div>
                    `).join('');
                }

                const imgPath = p.image ? `images/${p.image}` : 'https://via.placeholder.com/300x300?text=Sin+Imagen';

                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden border border-gray-100 flex flex-col";
                card.innerHTML = `
                    <div class="relative h-64 w-full bg-gray-100">
                        <img id="img-${p.id}" src="${imgPath}" alt="${p.name}" class="w-full h-full object-cover object-center" onerror="this.src='https://via.placeholder.com/300?text=Error+Imagen'">
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <span class="text-xs text-gray-400 uppercase tracking-wider font-semibold">${p.category}</span>
                        <h3 class="text-lg font-bold text-gray-900 mt-1">${p.name}</h3>
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2 flex-1">${p.desc}</p>
                        
                        ${variantSelectors}

                        <div class="mt-4 flex items-end justify-between">
                            <div class="flex flex-col">
                                <span class="precio-custom">$ ${p.price.toLocaleString('es-MX', {minimumFractionDigits: 2})} ${storeConfig.currency}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="qty-${p.id}" min="1" value="1" class="w-16 border rounded-md py-1 px-2 text-center text-sm">
                                <button onclick="addToCart(${p.id})" class="btn-primary rounded-full p-2 shadow-lg">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        window.changeProductImage = function(id, select) {
            const selectedOption = select.options[select.selectedIndex];
            const newImg = selectedOption.getAttribute('data-img');
            if (newImg && newImg !== '') {
                document.getElementById(`img-${id}`).src = `images/${newImg}`;
            }
        };

        window.addToCart = function(id) {
            const product = products.find(p => p.id === id);
            const qty = parseInt(document.getElementById(`qty-${id}`).value);
            
            let selectedVariants = [];
            if (Array.isArray(product.variants)) {
                product.variants.forEach((v, idx) => {
                    const select = document.getElementById(`var-select-${id}-${idx}`);
                    selectedVariants.push(`${v.label}: ${select.value}`);
                });
            }
            const variantString = selectedVariants.join(', ');

            const existingItem = cart.find(item => item.id === id && item.variant === variantString);

            if (existingItem) {
                existingItem.qty += qty;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    variant: variantString,
                    qty: qty
                });
            }

            const btn = document.querySelector(`button[onclick="addToCart(${id})"]`);
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i>`;
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-green-600');
                lucide.createIcons();
            }, 1000);

            updateCartUI();
        };

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartUI();
        };

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
            
            const cartContainer = document.getElementById('cart-items');
            const totalContainer = document.getElementById('cart-total');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Tu carrito está vacío</p>';
                totalContainer.innerText = "$ 0.00 " + storeConfig.currency;
                return;
            }

            let html = '';
            let total = 0;

            cart.forEach((item, index) => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                const imgPath = item.image ? `images/${item.image}` : 'https://via.placeholder.com/100';

                html += `
                    <div class="flex py-4 border-b">
                        <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-md border border-gray-200">
                            <img src="${imgPath}" alt="${item.name}" class="h-full w-full object-cover object-center">
                        </div>
                        <div class="ml-4 flex flex-1 flex-col">
                            <div>
                                <div class="flex justify-between text-base font-medium text-gray-900">
                                    <h3>${item.name}</h3>
                                    <p class="ml-4 text-primary font-bold">$${subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2})}</p>
                                </div>
                                ${item.variant ? `<p class="mt-1 text-sm text-gray-500">${item.variant}</p>` : ''}
                            </div>
                            <div class="flex flex-1 items-end justify-between text-sm">
                                <p class="text-gray-500">Cant: ${item.qty}</p>
                                <button type="button" onclick="removeFromCart(${index})" class="font-medium text-red-600 hover:text-red-500">Eliminar</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            cartContainer.innerHTML = html;
            totalContainer.innerText = `$ ${total.toLocaleString('es-MX', {minimumFractionDigits: 2})} ${storeConfig.currency}`;
        }

        window.toggleCart = function() {
            const modal = document.getElementById('cart-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                updateCartUI();
            } else {
                modal.classList.add('hidden');
            }
        };

        window.processCheckout = function(e) {
            e.preventDefault();
            if (cart.length === 0) {
                alert("Agrega productos al carrito primero.");
                return;
            }

            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;

            let message = `*NUEVO PEDIDO - ${storeConfig.name}*\n\n`;
            message += `*Cliente:* ${name}\n`;
            message += `*Tel:* ${phone}\n`;
            message += `*Dirección:* ${address}\n\n`;
            message += `*DETALLE DEL PEDIDO:*\n`;
            
            let total = 0;
            cart.forEach(item => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                message += `▪ ${item.qty}x ${item.name} ${item.variant ? '('+item.variant+')' : ''}\n   $${subtotal.toLocaleString('es-MX')}\n`;
            });

            message += `\n*TOTAL: $ ${total.toLocaleString('es-MX', {minimumFractionDigits: 2})} ${storeConfig.currency}*`;

            const encodedMsg = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${storeConfig.prefix}${storeConfig.phone}?text=${encodedMsg}`;
            
            window.open(whatsappUrl, '_blank');
        };
    </script>
</body>
</html>
