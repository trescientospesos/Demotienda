<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Tienda...</title>
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
    
    <style id="dynamic-styles">
        /* Estilos Base - Est√©tica Tienda */
        :root { --primary: #000000; --text-main: #1e293b; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; color: var(--text-main); background-color: #ffffff; }
        
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .product-img-container { width: 100%; aspect-ratio: 1/1; overflow: hidden; position: relative; background: #f3f4f6; }
        .product-img-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card-hover:hover .product-img-container img { transform: scale(1.05); }
        
        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Variantes */
        .variant-option input:checked + div { border-color: var(--primary); background-color: var(--primary); color: white; }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-100 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 id="shop-name" class="text-xl font-bold tracking-tight">Tienda</h1>
                <p id="shop-desc" class="text-xs text-gray-500">Cat√°logo</p>
            </div>
            <!-- Bot√≥n Carrito -->
            <button onclick="toggleCart()" class="relative p-2 rounded-full hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <span id="cart-badge" class="absolute top-0 right-0 bg-black text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
            </button>
        </div>
        
        <!-- Categor√≠as Scroll -->
        <div class="overflow-x-auto no-scrollbar pb-2 px-4">
            <div id="category-list" class="flex gap-2 whitespace-nowrap">
                <!-- Se llenan con JS -->
            </div>
        </div>
    </header>

    <!-- Grid Productos -->
    <main class="max-w-md mx-auto p-4">
        <div id="product-grid" class="grid grid-cols-2 gap-4">
            <!-- Renderizado din√°mico -->
        </div>
    </main>

    <!-- Modal Producto -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="absolute bottom-0 w-full max-w-md left-1/2 -translate-x-1/2 bg-white rounded-t-2xl overflow-hidden shadow-2xl max-h-[90vh] flex flex-col transform transition-transform duration-300 translate-y-full" id="modal-content">
            
            <!-- Imagen Modal -->
            <div class="relative h-64 bg-gray-100">
                <img id="modal-img" src="" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/80 p-1 rounded-full shadow-sm">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <!-- Info Scrollable -->
            <div class="p-6 overflow-y-auto pb-32">
                <h2 id="modal-title" class="text-2xl font-bold mb-1"></h2>
                <p id="modal-price" class="text-xl font-semibold text-gray-900 mb-4"></p>
                <p id="modal-desc" class="text-gray-600 text-sm leading-relaxed mb-6"></p>

                <!-- √Årea de Variantes Din√°micas -->
                <div id="modal-variants" class="space-y-4 mb-6"></div>
                
                <!-- Nota Opcional -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nota adicional (opcional)</label>
                    <textarea id="modal-notes" rows="2" class="w-full border-gray-300 bg-gray-50 rounded-lg p-3 text-sm focus:ring-1 focus:ring-black focus:border-black outline-none resize-none" placeholder="Ej: Envolver para regalo..."></textarea>
                </div>
            </div>

            <!-- Footer Modal -->
            <div class="absolute bottom-0 w-full p-4 bg-white border-t border-gray-100 flex items-center gap-4">
                <div class="flex items-center border rounded-lg bg-gray-50">
                    <button onclick="updateModalQty(-1)" class="px-4 py-3 hover:bg-gray-200 text-lg">-</button>
                    <span id="modal-qty" class="w-8 text-center font-semibold">1</span>
                    <button onclick="updateModalQty(1)" class="px-4 py-3 hover:bg-gray-200 text-lg">+</button>
                </div>
                <button onclick="addToCart()" class="flex-1 bg-black text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
                    <span>A√±adir</span>
                    <span id="modal-btn-price"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Carrito -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleCart()"></div>
        <div class="absolute bottom-0 right-0 w-full max-w-md h-full bg-white shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full sm:right-0 sm:left-auto" id="cart-content">
            
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-lg font-bold">Tu Bolsa de Compra</h2>
                <button onclick="toggleCart()" class="p-2 hover:bg-gray-200 rounded-full"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>

            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                <!-- Items -->
            </div>

            <div class="p-4 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-gray-500">Total</span>
                    <span id="cart-total" class="text-2xl font-bold"></span>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="order-name" placeholder="Tu Nombre" class="w-full p-3 bg-gray-50 border rounded-lg outline-none focus:ring-1 focus:ring-black">
                    <input type="text" id="order-address" placeholder="Direcci√≥n de env√≠o completa" class="w-full p-3 bg-gray-50 border rounded-lg outline-none focus:ring-1 focus:ring-black">
                    
                    <button onclick="sendOrder()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <span>Realizar Pedido por WhatsApp</span>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ***************************************************************
        // CONFIGURACI√ìN DE DATOS (IMPORTANTE)
        // ***************************************************************
        // Si quieres usar Google Sheets:
        // 1. Ve a tu Google Sheet -> Archivo -> Compartir -> Publicar en la web
        // 2. Selecciona "Valores separados por comas (.csv)" en el desplegable
        // 3. Pega el enlace que te da Google dentro de las comillas de abajo.
        // ***************************************************************
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1KozzCGxqXqH94c8y8KofJfhgMZZ-FvuNxKpC8M00VVg/edit?usp=sharing"; 
        // ***************************************************************

        // Configuraci√≥n y Estado
        let STORE_DATA = {};
        let PRODUCTS = [];
        let state = {
            activeCategory: 'Todos',
            cart: [],
            currentProduct: null,
            modalQty: 1,
            selectedVariants: {} // { "Talla": "M", "Color": "Rojo" }
        };

        // Funci√≥n para resolver rutas de im√°genes
        const getImgPath = (imgName) => {
            if (!imgName) return 'https://via.placeholder.com/300?text=Sin+Imagen';
            if (imgName.startsWith('http')) return imgName; // Por si acaso sigue habiendo URLs completas
            return `images/${imgName}`;
        };

        // Iniciar
        window.addEventListener('DOMContentLoaded', () => {
            // Usa la URL de Google Sheets si existe, si no, usa el archivo local
            const csvSource = GOOGLE_SHEET_URL || 'datos_tienda.csv';

            Papa.parse(csvSource, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: (err) => alert('Error cargando datos: ' + err)
            });
        });

        function processData(data) {
            if(!data.length) return;
            
            // Datos de la Tienda (Primera fila)
            const info = data[0];
            STORE_DATA = {
                name: info.Tienda_Nombre,
                desc: info.Tienda_Descripcion,
                phone: info.Tienda_Telefono,
                prefix: info.Tienda_Prefijo,
                currency: info.Tienda_Moneda || '$',
                color1: info.Tienda_Color_1 || '#000000',
                color2: info.Tienda_Color_2 || '#1e293b',
                accent: info.Tienda_Color_Acento || '#000000'
            };

            // Aplicar Estilos
            document.documentElement.style.setProperty('--primary', STORE_DATA.accent);
            document.documentElement.style.setProperty('--text-main', STORE_DATA.color2);
            document.getElementById('shop-name').textContent = STORE_DATA.name;
            document.getElementById('shop-desc').textContent = STORE_DATA.desc;
            document.title = STORE_DATA.name;

            // Procesar Productos
            PRODUCTS = data.map((row, index) => {
                if(!row.Prod_Nombre) return null;
                return {
                    id: index,
                    cat: row.Prod_Categoria,
                    name: row.Prod_Nombre,
                    desc: row.Prod_Descripcion,
                    price: parseFloat(row.Prod_Precio),
                    img: row.Prod_Imagen, 
                    // Parseo de Variantes Flexible: "Grupo:Opci√≥n|Img,Opci√≥n;Grupo2:Opci√≥n"
                    variants: parseVariants(row.Prod_Variantes)
                };
            }).filter(p => p !== null);

            renderCategories();
            renderProducts();
        }

        function parseVariants(variantString) {
            if (!variantString) return [];
            // Formato esperado: "Color:Rojo|img1.jpg,Azul;Talla:S,M,L"
            return variantString.split(';').map(groupStr => {
                const [groupName, optionsStr] = groupStr.split(':');
                if(!optionsStr) return null;
                
                const options = optionsStr.split(',').map(opt => {
                    // Opci√≥n formato: "Nombre|Imagen"
                    const [optName, optImg] = opt.split('|');
                    return { name: optName.trim(), image: optImg ? optImg.trim() : null };
                });
                
                return { name: groupName.trim(), options };
            }).filter(g => g !== null);
        }

        function renderCategories() {
            const categories = ['Todos', ...new Set(PRODUCTS.map(p => p.cat))];
            const container = document.getElementById('category-list');
            
            container.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat}')" 
                    class="px-4 py-2 rounded-full text-sm font-medium transition-colors ${state.activeCategory === cat ? 'bg-black text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                    ${cat}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            state.activeCategory = cat;
            renderCategories();
            renderProducts();
        }

        function renderProducts() {
            const grid = document.getElementById('product-grid');
            const filtered = state.activeCategory === 'Todos' 
                ? PRODUCTS 
                : PRODUCTS.filter(p => p.cat === state.activeCategory);

            grid.innerHTML = filtered.map(p => `
                <div onclick="openProduct(${p.id})" class="bg-white rounded-lg cursor-pointer group card-hover fade-in">
                    <div class="product-img-container rounded-lg mb-3">
                        <img src="${getImgPath(p.img)}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300?text=Sin+Imagen'">
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 leading-tight">${p.name}</h3>
                        <p class="text-xs text-gray-500 mt-1 line-clamp-2">${p.desc}</p>
                        <div class="mt-2 font-bold text-gray-900">${STORE_DATA.currency}${p.price.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- L√≥gica del Modal ---

        function openProduct(id) {
            state.currentProduct = PRODUCTS.find(p => p.id === id);
            state.modalQty = 1;
            state.selectedVariants = {}; 
            
            // Pre-seleccionar primeras opciones
            if(state.currentProduct.variants.length > 0) {
                state.currentProduct.variants.forEach(group => {
                    if(group.options.length > 0) {
                        state.selectedVariants[group.name] = group.options[0];
                    }
                });
            }

            updateModalUI();
            
            document.getElementById('product-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('translate-y-full');
            }, 10);
        }

        function updateModalUI() {
            const p = state.currentProduct;
            
            // Determinar imagen a mostrar (Base o Variante)
            let displayImg = p.img;
            // Buscar si alguna variante seleccionada tiene imagen
            Object.values(state.selectedVariants).forEach(opt => {
                if(opt && opt.image) displayImg = opt.image;
            });

            document.getElementById('modal-img').src = getImgPath(displayImg);
            document.getElementById('modal-title').textContent = p.name;
            document.getElementById('modal-desc').textContent = p.desc;
            document.getElementById('modal-price').textContent = `${STORE_DATA.currency}${p.price.toFixed(2)}`;
            document.getElementById('modal-qty').textContent = state.modalQty;
            document.getElementById('modal-notes').value = '';

            // Render Variantes
            const variantContainer = document.getElementById('modal-variants');
            variantContainer.innerHTML = p.variants.map(group => `
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-2 uppercase tracking-wider">${group.name}</h4>
                    <div class="flex flex-wrap gap-2">
                        ${group.options.map(opt => `
                            <label class="cursor-pointer variant-option">
                                <input type="radio" name="${group.name}" class="hidden" 
                                    ${state.selectedVariants[group.name]?.name === opt.name ? 'checked' : ''}
                                    onchange="selectVariant('${group.name}', '${opt.name}')">
                                <div class="px-4 py-2 rounded-md border text-sm font-medium hover:border-black transition-all bg-white text-gray-700">
                                    ${opt.name}
                                </div>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            updateAddBtn();
        }

        function selectVariant(groupName, optionName) {
            const group = state.currentProduct.variants.find(g => g.name === groupName);
            const option = group.options.find(o => o.name === optionName);
            
            state.selectedVariants[groupName] = option;
            updateModalUI(); // Para actualizar imagen si es necesario
        }

        function updateModalQty(change) {
            const newQty = state.modalQty + change;
            if(newQty >= 1) {
                state.modalQty = newQty;
                document.getElementById('modal-qty').textContent = state.modalQty;
                updateAddBtn();
            }
        }

        function updateAddBtn() {
            const total = state.currentProduct.price * state.modalQty;
            document.getElementById('modal-btn-price').textContent = `${STORE_DATA.currency}${total.toFixed(2)}`;
        }

        function closeModal() {
            document.getElementById('modal-content').classList.add('translate-y-full');
            setTimeout(() => {
                document.getElementById('product-modal').classList.add('hidden');
            }, 300);
        }

        // --- L√≥gica del Carrito ---

        function addToCart() {
            const item = {
                id: state.currentProduct.id, // ID base
                cartId: Date.now(), // ID √∫nico para el carrito (permite duplicados con diferentes variantes)
                name: state.currentProduct.name,
                price: state.currentProduct.price,
                img: document.getElementById('modal-img').src, // Guardamos la ruta completa resuelta
                qty: state.modalQty,
                variants: { ...state.selectedVariants }, // Copia del estado
                notes: document.getElementById('modal-notes').value
            };

            state.cart.push(item);
            closeModal();
            updateCartBadge();
            // Feedback visual simple
            const btn = document.querySelector('button[onclick="toggleCart()"]');
            btn.classList.add('bg-gray-200');
            setTimeout(() => btn.classList.remove('bg-gray-200'), 200);
        }

        function updateCartBadge() {
            const count = state.cart.reduce((acc, item) => acc + item.qty, 0);
            const badge = document.getElementById('cart-badge');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
        }

        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            const content = document.getElementById('cart-content');
            
            if(modal.classList.contains('hidden')) {
                renderCartItems();
                modal.classList.remove('hidden');
                setTimeout(() => content.classList.remove('translate-x-full'), 10);
            } else {
                content.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items');
            let total = 0;

            if(state.cart.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400">Tu bolsa est√° vac√≠a</div>';
                document.getElementById('cart-total').textContent = `${STORE_DATA.currency}0.00`;
                return;
            }

            container.innerHTML = state.cart.map((item, index) => {
                total += item.price * item.qty;
                
                // Formatear variantes para mostrar
                const variantText = Object.entries(item.variants)
                    .map(([key, val]) => `<span class="text-xs bg-gray-100 px-2 py-0.5 rounded mr-1">${key}: ${val.name}</span>`)
                    .join('');

                return `
                <div class="flex gap-4 bg-white p-3 rounded-lg border border-gray-100">
                    <img src="${item.img}" class="w-20 h-20 object-cover rounded-md bg-gray-50" onerror="this.src='https://via.placeholder.com/300?text=Error'">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-sm text-gray-900">${item.name}</h4>
                            <button onclick="removeItem(${index})" class="text-gray-400 hover:text-red-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        
                        <div class="flex flex-wrap gap-1 mt-1 mb-2">
                            ${variantText}
                        </div>
                        ${item.notes ? `<p class="text-xs text-gray-500 italic mb-2">"${item.notes}"</p>` : ''}

                        <div class="flex justify-between items-end">
                            <div class="text-xs text-gray-500">Cant: ${item.qty}</div>
                            <div class="font-bold text-gray-900">${STORE_DATA.currency}${(item.price * item.qty).toFixed(2)}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('cart-total').textContent = `${STORE_DATA.currency}${total.toFixed(2)}`;
        }

        function removeItem(index) {
            state.cart.splice(index, 1);
            renderCartItems();
            updateCartBadge();
        }

        function sendOrder() {
            const name = document.getElementById('order-name').value.trim();
            const address = document.getElementById('order-address').value.trim();
            
            if(!name || !address) return alert("Por favor escribe tu nombre y direcci√≥n de env√≠o.");
            if(state.cart.length === 0) return alert("La bolsa est√° vac√≠a");

            let msg = `üõçÔ∏è *PEDIDO NUEVO - ${name.toUpperCase()}*\n`;
            msg += `üìç *Direcci√≥n:* ${address}\n`;
            msg += `--------------------------------\n`;
            
            state.cart.forEach(i => {
                msg += `‚ñ™Ô∏è ${i.qty}x *${i.name}*\n`;
                // A√±adir variantes al mensaje
                Object.entries(i.variants).forEach(([k, v]) => {
                    msg += `   ‚îî ${k}: ${v.name}\n`;
                });
                if(i.notes) msg += `   üìù Nota: ${i.notes}\n`;
            });
            
            msg += `--------------------------------\n`;
            msg += `üí∞ *TOTAL: ${document.getElementById('cart-total').innerText}*`;

            const phone = STORE_DATA.prefix + STORE_DATA.phone;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
