<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Tienda...</title>
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style id="dynamic-styles">
        :root { --primary: #000000; --text-main: #1e293b; --bg-card: #ffffff; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; color: var(--text-main); background-color: #f3f4f6; }
        
        /* Utilidades custom */
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .border-primary { border-color: var(--primary); }
        .ring-primary { --tw-ring-color: var(--primary); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .variant-selected { 
            background-color: var(--text-main); 
            color: white; 
            border-color: var(--text-main);
        }
        
        /* Aspecto de tienda */
        .product-card { transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .aspect-product { aspect-ratio: 1 / 1; object-fit: cover; } /* Cuadrado para productos */
    </style>
</head>
<body class="pb-24">

    <!-- Header / Navbar -->
    <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div id="store-logo" class="w-8 h-8 rounded bg-gray-200 overflow-hidden hidden">
                    <img id="nav-logo-img" class="w-full h-full object-cover">
                </div>
                <h1 id="store-name" class="text-xl font-bold tracking-tight">Tienda</h1>
            </div>
            <button onclick="toggleCart()" class="relative p-2 hover:bg-gray-100 rounded-full transition">
                <i data-lucide="shopping-bag" class="w-6 h-6 text-gray-700"></i>
                <span id="cart-count" class="absolute top-0 right-0 bg-black text-white text-xs font-bold px-1.5 py-0.5 rounded-full transform scale-0 transition-transform">0</span>
            </button>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <p id="store-desc" class="text-gray-500 mb-4 max-w-lg">Cargando descripci√≥n...</p>
            <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                <div class="flex items-center gap-1"><i data-lucide="phone" class="w-4 h-4"></i> <span id="store-phone">...</span></div>
                <div class="flex items-center gap-1 text-green-600 bg-green-50 px-2 py-1 rounded-full"><i data-lucide="check-circle" class="w-4 h-4"></i> <span>Disponible ahora</span></div>
            </div>
        </div>
    </header>

    <!-- Categor√≠as -->
    <div class="sticky top-[60px] z-30 bg-white shadow-sm border-b border-gray-100 overflow-x-auto no-scrollbar">
        <div id="category-container" class="flex px-4 py-3 gap-2 max-w-4xl mx-auto min-w-max">
            <!-- Se llenan din√°micamente -->
        </div>
    </div>

    <!-- Grid de Productos -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
            <!-- Productos aqu√≠ -->
        </div>
    </main>

    <!-- Modal de Producto -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeProductModal()"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[500px] md:h-auto h-[90vh] bg-white md:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col overflow-hidden transition-transform duration-300 translate-y-full" id="modal-content">
            
            <!-- Imagen Modal -->
            <div class="relative h-64 md:h-72 bg-gray-100 shrink-0">
                <button onclick="closeProductModal()" class="absolute top-4 right-4 bg-white/80 p-2 rounded-full shadow hover:bg-white z-10">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
                <img id="modal-img" src="" class="w-full h-full object-contain mix-blend-multiply p-4" alt="Producto">
            </div>

            <!-- Contenido Scrollable -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-900 leading-tight"></h2>
                    <p id="modal-price" class="text-xl font-semibold text-gray-900 mt-1"></p>
                    <p id="modal-desc" class="text-gray-500 mt-2 text-sm leading-relaxed"></p>
                </div>

                <!-- Contenedor de Variantes (Color, Talla, etc) -->
                <div id="modal-variants" class="space-y-4"></div>

                <!-- Notas -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notas adicionales (opcional)</label>
                    <textarea id="modal-notes" rows="2" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-black focus:border-transparent outline-none resize-none" placeholder="Ej: Envolver para regalo..."></textarea>
                </div>
            </div>

            <!-- Footer con Bot√≥n -->
            <div class="p-4 border-t border-gray-100 bg-white">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden shrink-0">
                        <button onclick="adjustModalQty(-1)" class="p-3 hover:bg-gray-100"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        <span id="modal-qty" class="w-8 text-center font-semibold text-sm">1</span>
                        <button onclick="adjustModalQty(1)" class="p-3 hover:bg-gray-100"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="addToCartFromModal()" class="flex-1 bg-black text-white py-3.5 px-4 rounded-xl font-medium hover:bg-gray-800 transition active:scale-95 flex justify-center items-center gap-2">
                        <span>A√±adir</span>
                        <span id="modal-btn-price"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Carrito (Slide over) -->
    <div id="cart-overlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" onclick="toggleCart()"></div>
        <div class="absolute top-0 right-0 w-full max-w-md h-full bg-white shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-white">
                <h2 class="text-lg font-bold">Tu Cesta</h2>
                <button onclick="toggleCart()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-6 bg-gray-50">
                <!-- Items del carrito -->
                <div class="text-center text-gray-400 mt-10">
                    <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                    <p>Tu cesta est√° vac√≠a</p>
                </div>
            </div>

            <div class="p-6 bg-white border-t border-gray-100 shadow-up">
                <div class="flex justify-between items-center mb-4 text-lg font-bold">
                    <span>Total</span>
                    <span id="cart-total">$0.00</span>
                </div>

                <div class="space-y-3 mb-4">
                    <input type="text" id="order-name" placeholder="Tu Nombre" class="w-full p-3 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black outline-none transition">
                    
                    <div class="flex gap-2 p-1 bg-gray-100 rounded-lg">
                        <button onclick="setDelivery('pickup')" id="btn-pickup" class="flex-1 py-2 text-sm font-medium rounded shadow-sm bg-white text-black transition">Recoger</button>
                        <button onclick="setDelivery('delivery')" id="btn-delivery" class="flex-1 py-2 text-sm font-medium rounded text-gray-500 hover:text-black transition">Env√≠o</button>
                    </div>

                    <div id="address-field" class="hidden">
                        <input type="text" id="order-address" placeholder="Direcci√≥n de env√≠o completa" class="w-full p-3 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black outline-none transition">
                    </div>
                    
                    <textarea id="order-notes" rows="2" placeholder="Nota general para el pedido..." class="w-full p-3 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-black outline-none transition resize-none"></textarea>
                </div>

                <button onclick="checkout()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-800 transition shadow-lg active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>Completar Pedido en WhatsApp</span>
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN & ESTADO ---
        const CSV_URL = 'datos_tienda.csv'; 
        
        let state = {
            products: [],
            cart: [],
            storeInfo: {},
            categories: [],
            activeCategory: 'Todos',
            currentModalProduct: null,
            modalQty: 1,
            selectedVariants: {}, // { "Color": {name: "Rojo", price: 0, img: "..."}, "Talla": ... }
            deliveryType: 'pickup', // pickup | delivery
            currency: '$'
        };

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            lucide.createIcons();
        });

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("No se pudo cargar el CSV");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        processData(results.data);
                    }
                });
            } catch (error) {
                console.error(error);
                alert("Error cargando datos. Aseg√∫rate de que 'datos_tienda.csv' existe.");
            }
        }

        function processData(data) {
            if(!data.length) return;

            // 1. Extraer Info de la Tienda (primera fila v√°lida)
            const infoRow = data.find(row => row.Tienda_Nombre);
            if (infoRow) {
                state.storeInfo = {
                    name: infoRow.Tienda_Nombre,
                    desc: infoRow.Tienda_Descripcion,
                    phone: infoRow.Tienda_Telefono,
                    currency: infoRow.Tienda_Moneda || '$',
                    color1: infoRow.Tienda_Color_1 || '#000000',
                    color2: infoRow.Tienda_Color_2 || '#ffffff',
                    accent: infoRow.Tienda_Color_Acento || '#000000'
                };
                applyTheme();
            }

            // 2. Procesar Productos
            state.products = data
                .filter(r => r.Prod_Nombre) // Solo filas con producto
                .map((r, index) => ({
                    id: index,
                    category: r.Prod_Categoria,
                    name: r.Prod_Nombre,
                    desc: r.Prod_Descripcion,
                    price: parseFloat(r.Prod_Precio || 0),
                    image: r.Prod_Imagen || 'https://via.placeholder.com/300?text=Sin+Imagen',
                    // Parseo inteligente de variantes: "Grupo:Opcion:Precio:Imagen"
                    // Formato esperado en CSV (Columna Prod_Variantes): "Color:Rojo:0:img1.jpg, Color:Azul:0:img2.jpg, Talla:S:0, Talla:M:0"
                    variants: parseVariants(r.Prod_Variantes) 
                }));

            // 3. Extraer Categor√≠as √∫nicas
            const cats = new Set(state.products.map(p => p.category));
            state.categories = ['Todos', ...cats];

            renderCategories();
            renderProducts();
        }

        // --- PARSEADOR DE VARIANTES ---
        // Espera formato: "Grupo:Opci√≥n:PrecioExtra:UrlImagen" separado por comas
        // Ejemplo: "Color:Rojo:0:red.jpg, Color:Verde:0:green.jpg, Talla:XL:20"
        function parseVariants(str) {
            if (!str) return [];
            return str.split(',').map(s => {
                const parts = s.split(':').map(p => p.trim());
                // parts[0] = Grupo (ej: Color)
                // parts[1] = Nombre (ej: Rojo)
                // parts[2] = Precio Extra (ej: 10)
                // parts[3] = Imagen Override (opcional)
                return {
                    group: parts[0] || 'Opciones',
                    name: parts[1] || parts[0],
                    price: parseFloat(parts[2] || 0),
                    image: parts[3] || null
                };
            }).filter(v => v.name);
        }

        function applyTheme() {
            document.documentElement.style.setProperty('--primary', state.storeInfo.color1);
            document.getElementById('store-name').innerText = state.storeInfo.name;
            document.getElementById('store-desc').innerText = state.storeInfo.desc;
            document.getElementById('store-phone').innerText = state.storeInfo.phone;
            document.title = state.storeInfo.name;
            state.currency = state.storeInfo.currency;
        }

        // --- RENDERIZADO ---
        function renderCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = state.categories.map(cat => `
                <button 
                    onclick="setCategory('${cat}')" 
                    class="px-5 py-2 rounded-full text-sm font-medium transition whitespace-nowrap ${state.activeCategory === cat ? 'bg-black text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                >
                    ${cat}
                </button>
            `).join('');
        }

        function setCategory(cat) {
            state.activeCategory = cat;
            renderCategories();
            renderProducts();
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const filtered = state.activeCategory === 'Todos' 
                ? state.products 
                : state.products.filter(p => p.category === state.activeCategory);

            grid.innerHTML = filtered.map(p => `
                <div class="product-card bg-white rounded-xl overflow-hidden cursor-pointer flex flex-col h-full border border-gray-100" onclick="openProductModal(${p.id})">
                    <div class="relative w-full aspect-product overflow-hidden bg-gray-50">
                        <img src="${p.image}" class="w-full h-full object-contain mix-blend-multiply p-4" alt="${p.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=No+Img'">
                        <button class="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow-md hover:bg-black hover:text-white transition">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-gray-900 leading-snug mb-1 text-sm md:text-base">${p.name}</h3>
                        <p class="text-xs text-gray-500 line-clamp-2 mb-2 flex-1">${p.desc}</p>
                        <div class="text-black font-semibold mt-auto">${state.currency}${p.price.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- MODAL DE PRODUCTO Y VARIANTES ---
        function openProductModal(id) {
            const product = state.products.find(p => p.id === id);
            state.currentModalProduct = product;
            state.modalQty = 1;
            state.selectedVariants = {}; // Reseteamos selecci√≥n
            
            document.getElementById('modal-title').innerText = product.name;
            document.getElementById('modal-desc').innerText = product.desc;
            document.getElementById('modal-price').innerText = `${state.currency}${product.price.toFixed(2)}`;
            document.getElementById('modal-img').src = product.image;
            // Guardar imagen original para revertir si se deselecciona variante (opcional)
            document.getElementById('modal-img').dataset.original = product.image; 

            document.getElementById('modal-qty').innerText = 1;
            document.getElementById('modal-notes').value = '';

            renderVariants(product.variants);
            updateModalTotal();

            const modal = document.getElementById('product-modal');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            // Small timeout for animation
            setTimeout(() => {
                content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderVariants(variants) {
            const container = document.getElementById('modal-variants');
            container.innerHTML = '';

            if (!variants || variants.length === 0) return;

            // Agrupar variantes por su propiedad 'group'
            const groups = {};
            variants.forEach(v => {
                if (!groups[v.group]) groups[v.group] = [];
                groups[v.group].push(v);
            });

            // Renderizar cada grupo
            Object.keys(groups).forEach(groupName => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'border-b border-gray-100 pb-4';
                
                const title = document.createElement('h4');
                title.className = 'text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide';
                title.innerText = groupName;
                groupDiv.appendChild(title);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'flex flex-wrap gap-2';

                groups[groupName].forEach(variant => {
                    const btn = document.createElement('button');
                    // Estilo base de "p√≠ldora" o "chip"
                    btn.className = `px-4 py-2 text-sm border rounded-lg transition select-none flex items-center gap-2 ${
                        state.selectedVariants[groupName] === variant 
                        ? 'variant-selected border-black bg-black text-white' 
                        : 'border-gray-200 text-gray-700 hover:border-gray-400 bg-white'
                    }`;
                    
                    // Contenido del bot√≥n
                    let content = `<span>${variant.name}</span>`;
                    if(variant.price > 0) content += `<span class="opacity-60 text-xs">+${state.currency}${variant.price}</span>`;
                    btn.innerHTML = content;

                    btn.onclick = () => selectVariant(groupName, variant);
                    optionsDiv.appendChild(btn);
                });

                groupDiv.appendChild(optionsDiv);
                container.appendChild(groupDiv);
            });
        }

        function selectVariant(group, variantObj) {
            // Guardar selecci√≥n
            state.selectedVariants[group] = variantObj;
            
            // Si la variante tiene imagen espec√≠fica, cambiarla
            if(variantObj.image) {
                const imgEl = document.getElementById('modal-img');
                imgEl.src = variantObj.image;
                // Peque√±a animaci√≥n de fade para la imagen
                imgEl.classList.remove('fade-in');
                void imgEl.offsetWidth; // trigger reflow
                imgEl.classList.add('fade-in');
            }

            renderVariants(state.currentModalProduct.variants); // Re-render para actualizar estilos active
            updateModalTotal();
        }

        function adjustModalQty(delta) {
            const newQty = state.modalQty + delta;
            if (newQty >= 1) {
                state.modalQty = newQty;
                document.getElementById('modal-qty').innerText = state.modalQty;
                updateModalTotal();
            }
        }

        function updateModalTotal() {
            let base = state.currentModalProduct.price;
            let extras = 0;
            
            // Sumar precio de variantes seleccionadas
            Object.values(state.selectedVariants).forEach(v => {
                extras += v.price;
            });

            const total = (base + extras) * state.modalQty;
            document.getElementById('modal-btn-price').innerText = `${state.currency}${total.toFixed(2)}`;
        }

        function addToCartFromModal() {
            // Validar que se haya seleccionado una opci√≥n de cada grupo disponible
            const productVariants = state.currentModalProduct.variants;
            if(productVariants.length > 0) {
                const availableGroups = new Set(productVariants.map(v => v.group));
                const selectedGroups = Object.keys(state.selectedVariants);
                
                // Comprobamos si falta alg√∫n grupo por seleccionar
                const missing = [...availableGroups].filter(g => !state.selectedVariants[g]);
                
                if(missing.length > 0) {
                    alert(`Por favor selecciona: ${missing.join(', ')}`);
                    return;
                }
            }

            const variantList = Object.values(state.selectedVariants);
            const variantPriceSum = variantList.reduce((acc, v) => acc + v.price, 0);

            // Generar un ID √∫nico para el item del carrito basado en sus opciones
            // Para agrupar items id√©nticos en el carrito
            const variantKey = variantList.map(v => v.name).sort().join('|');
            const cartId = `${state.currentModalProduct.id}-${variantKey}`;

            const existingItem = state.cart.find(item => item.cartId === cartId);

            if(existingItem) {
                existingItem.qty += state.modalQty;
            } else {
                state.cart.push({
                    cartId: cartId,
                    productId: state.currentModalProduct.id,
                    name: state.currentModalProduct.name,
                    price: state.currentModalProduct.price,
                    image: state.currentModalProduct.image, // Podr√≠amos guardar la imagen de la variante si queremos
                    qty: state.modalQty,
                    variants: variantList, // Array de objetos variante
                    variantTotal: variantPriceSum,
                    notes: document.getElementById('modal-notes').value
                });
            }

            closeProductModal();
            updateCartUI();
            
            // Animaci√≥n visual del carrito
            const cartBtn = document.querySelector('nav button');
            cartBtn.classList.add('scale-110');
            setTimeout(() => cartBtn.classList.remove('scale-110'), 200);
            
            // Abrir carrito autom√°ticamente (opcional, estilo tienda)
            toggleCart(true); 
        }

        // --- CARRITO ---
        function toggleCart(forceOpen = null) {
            const overlay = document.getElementById('cart-overlay');
            const panel = document.getElementById('cart-panel');
            const isOpen = !overlay.classList.contains('hidden');
            
            if (forceOpen === true || (forceOpen === null && !isOpen)) {
                overlay.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const countBadge = document.getElementById('cart-count');
            const totalEl = document.getElementById('cart-total');
            
            const totalQty = state.cart.reduce((sum, i) => sum + i.qty, 0);
            countBadge.innerText = totalQty;
            countBadge.classList.toggle('scale-0', totalQty === 0);

            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-10">
                        <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                        <p>Tu cesta est√° vac√≠a</p>
                    </div>`;
            } else {
                container.innerHTML = state.cart.map((item, idx) => `
                    <div class="flex gap-4 bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                        <div class="w-16 h-16 bg-gray-50 rounded-md overflow-hidden shrink-0">
                            <img src="${item.image}" class="w-full h-full object-contain mix-blend-multiply">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-sm text-gray-800">${item.name}</h4>
                                <button onclick="removeFromCart(${idx})" class="text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                            
                            <!-- Mostrar Variantes -->
                            <div class="text-xs text-gray-500 my-1">
                                ${item.variants.map(v => `<span class="bg-gray-100 px-1.5 py-0.5 rounded text-gray-600 mr-1">${v.name}</span>`).join('')}
                            </div>
                            
                            ${item.notes ? `<p class="text-xs italic text-gray-400">Nota: ${item.notes}</p>` : ''}
                            
                            <div class="flex justify-between items-center mt-2">
                                <div class="text-sm font-semibold">${state.currency}${((item.price + item.variantTotal) * item.qty).toFixed(2)}</div>
                                <div class="flex items-center border border-gray-200 rounded bg-white">
                                    <button onclick="updateCartQty(${idx}, -1)" class="px-2 py-0.5 text-gray-600 hover:bg-gray-50">-</button>
                                    <span class="px-2 text-xs font-medium">${item.qty}</span>
                                    <button onclick="updateCartQty(${idx}, 1)" class="px-2 py-0.5 text-gray-600 hover:bg-gray-50">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            }

            const totalAmount = state.cart.reduce((sum, i) => sum + ((i.price + i.variantTotal) * i.qty), 0);
            totalEl.innerText = `${state.currency}${totalAmount.toFixed(2)}`;
        }

        function updateCartQty(index, delta) {
            const item = state.cart[index];
            const newQty = item.qty + delta;
            if (newQty <= 0) {
                removeFromCart(index);
            } else {
                item.qty = newQty;
                updateCartUI();
            }
        }

        function removeFromCart(index) {
            state.cart.splice(index, 1);
            updateCartUI();
        }

        // --- CHECKOUT ---
        function setDelivery(type) {
            state.deliveryType = type;
            const bgClass = 'bg-black text-white shadow-md';
            const inactiveClass = 'bg-white text-black';
            
            document.getElementById('btn-pickup').className = `flex-1 py-2 text-sm font-medium rounded transition ${type === 'pickup' ? bgClass : inactiveClass}`;
            document.getElementById('btn-delivery').className = `flex-1 py-2 text-sm font-medium rounded transition ${type === 'delivery' ? bgClass : inactiveClass}`;
            
            const addrField = document.getElementById('address-field');
            if (type === 'delivery') addrField.classList.remove('hidden');
            else addrField.classList.add('hidden');
        }

        function checkout() {
            if (state.cart.length === 0) return alert("Tu cesta est√° vac√≠a");
            
            const name = document.getElementById('order-name').value.trim();
            const address = document.getElementById('order-address').value.trim();
            const generalNotes = document.getElementById('order-notes').value.trim();
            
            if(!name) return alert("Por favor escribe tu nombre.");
            if(state.deliveryType === 'delivery' && !address) return alert("Por favor escribe tu direcci√≥n de env√≠o.");

            // Formato de Ticket para Tienda
            let msg = `üõçÔ∏è *NUEVO PEDIDO: ${name.toUpperCase()}* \n`;
            msg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            msg += `üì¶ *M√©todo:* ${state.deliveryType==='delivery' ? 'üöö Env√≠o a Domicilio' : 'üè™ Recogida en Tienda'}\n`;
            if(state.deliveryType === 'delivery') msg += `üìç *Direcci√≥n:* ${address}\n`;
            msg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n`;
            
            state.cart.forEach(i => {
                const itemTotal = (i.price + i.variantTotal) * i.qty;
                msg += `‚ñ™Ô∏è *${i.qty}x ${i.name}*\n`;
                
                // Variantes en formato limpio: "Color: Rojo | Talla: XL"
                if(i.variants.length > 0) {
                    const variantsStr = i.variants.map(v => v.name).join(' | ');
                    msg += `   ‚Ü≥ _${variantsStr}_\n`;
                }
                
                if(i.notes) msg += `   üìù _Nota: ${i.notes}_\n`;
                msg += `   üí≤ Subtotal: ${state.currency}${itemTotal.toFixed(2)}\n\n`;
            });

            msg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            msg += `üí∞ *TOTAL A PAGAR: ${document.getElementById('cart-total').innerText}*\n`;
            if(generalNotes) msg += `üìù *Nota del pedido:* ${generalNotes}\n`;

            const phone = state.storeInfo.phone.replace(/\D/g, ''); 
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
