<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Tienda...</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para leer CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Iconos -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fuente Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb', // Color primario (Azul Tienda)
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        },
                        accent: {
                            500: '#f43f5e', // Rosa para detalles
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #f3f4f6; 
            padding-bottom: 120px; /* Espacio para la barra flotante */
        }
        
        /* Ocultar scrollbar en categor√≠as pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast Notificaci√≥n */
        #toast {
            visibility: hidden;
            min-width: 300px;
            background: #1e293b;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px 24px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%) translateY(20px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 600;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            bottom: 100px; /* Encima de la barra flotante */
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-brand-200 selection:text-brand-900">

    <!-- Pantalla de Carga -->
    <div id="loading" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative w-20 h-20">
            <div class="absolute top-0 left-0 w-full h-full border-4 border-brand-100 rounded-full"></div>
            <div class="absolute top-0 left-0 w-full h-full border-4 border-brand-600 rounded-full border-t-transparent animate-spin"></div>
        </div>
        <p class="text-slate-400 mt-4 font-medium tracking-wide animate-pulse">Cargando cat√°logo...</p>
    </div>

    <!-- Toast -->
    <div id="toast">
        <div class="bg-green-500 rounded-full p-1">
            <i data-lucide="check" class="w-4 h-4 text-white"></i>
        </div>
        <span id="toast-msg">Producto a√±adido</span>
    </div>

    <!-- HEADER PREMIUM -->
    <header class="relative bg-slate-900 text-white overflow-hidden pb-8 pt-6">
        <!-- Fondos animados -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
            <div class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-brand-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
            <div class="absolute top-[10%] left-[-10%] w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob" style="animation-delay: 2s"></div>
            <div class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob" style="animation-delay: 4s"></div>
        </div>

        <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Barra Superior -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 id="store-title" class="text-3xl md:text-4xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-brand-200">
                        Mi Tienda
                    </h1>
                    <p id="store-desc" class="text-brand-100 text-sm mt-1 font-medium opacity-80">Cat√°logo Exclusivo</p>
                </div>
                
                <button onclick="toggleCart()" class="group relative bg-white/10 hover:bg-white/20 backdrop-blur-md border border-white/10 p-3 rounded-2xl transition-all duration-300">
                    <i data-lucide="shopping-bag" class="text-white w-6 h-6 group-hover:scale-110 transition-transform"></i>
                    <span id="header-cart-count" class="absolute -top-2 -right-2 bg-accent-500 text-white text-[10px] font-bold rounded-lg h-6 min-w-[24px] flex items-center justify-center border-2 border-slate-900 shadow-lg transform scale-0 transition-transform duration-300">0</span>
                </button>
            </div>

            <!-- Buscador y Categor√≠as -->
            <div class="space-y-6">
                <!-- Buscador -->
                <div class="relative max-w-2xl mx-auto transform transition-all hover:scale-[1.01]">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-slate-400"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Buscar productos..." class="block w-full pl-11 pr-4 py-4 bg-white/10 border border-white/10 rounded-2xl leading-5 text-white placeholder-slate-300 focus:outline-none focus:bg-white/20 focus:border-white/30 focus:ring-0 sm:text-sm backdrop-blur-md shadow-lg transition-all">
                </div>

                <!-- Categor√≠as (Horizontal Scroll) -->
                <div id="category-container" class="flex space-x-3 overflow-x-auto no-scrollbar pb-2 pt-1 justify-start md:justify-center">
                    <!-- Botones insertados din√°micamente -->
                </div>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="relative z-20 -mt-6 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Productos renderizados aqu√≠ -->
        </div>
        
        <!-- Mensaje sin resultados -->
        <div id="no-results" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
                <i data-lucide="search-x" class="w-8 h-8 text-slate-400"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-900">No encontramos productos</h3>
            <p class="text-slate-500">Intenta con otra b√∫squeda o categor√≠a.</p>
        </div>
    </main>

    <!-- BARRA FLOTANTE (STICKY FOOTER) -->
    <div id="sticky-cart-bar" class="fixed bottom-0 left-0 w-full glass-dark z-40 transform translate-y-full transition-transform duration-500 ease-in-out shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-brand-600/20 p-2.5 rounded-xl hidden sm:block">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-brand-400"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase tracking-wider text-slate-400 font-bold">Total estimado</span>
                    <span id="sticky-total" class="font-bold text-2xl text-white tracking-tight">$0.00</span>
                </div>
            </div>
            <button onclick="toggleCart()" class="bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-500 hover:to-brand-400 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg shadow-brand-600/30 flex items-center gap-2 transition-all active:scale-95">
                Ver Pedido <i data-lucide="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- DRAWER DEL CARRITO (OFF-CANVAS) -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity opacity-0" id="cart-backdrop" onclick="toggleCart()"></div>
        
        <!-- Panel Lateral -->
        <div class="fixed inset-y-0 right-0 flex max-w-full pl-10 pointer-events-none">
            <div class="w-screen max-w-md transform translate-x-full transition-transform duration-300 ease-in-out pointer-events-auto" id="cart-panel">
                <div class="flex h-full flex-col bg-white shadow-2xl">
                    <!-- Header Drawer -->
                    <div class="px-6 py-6 border-b border-slate-100 bg-white flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Tu Carrito</h2>
                            <p class="text-sm text-slate-500">Revisa tus items antes de enviar</p>
                        </div>
                        <button onclick="toggleCart()" class="rounded-full p-2 text-slate-400 hover:text-slate-500 hover:bg-slate-100 transition">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Lista Items -->
                    <div class="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                        <div id="cart-items-container" class="space-y-4">
                            <!-- Items din√°micos -->
                        </div>
                        
                        <!-- Estado Vac√≠o -->
                        <div id="empty-cart-msg" class="hidden flex flex-col items-center justify-center h-64 text-center">
                            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="shopping-basket" class="w-10 h-10 text-slate-300"></i>
                            </div>
                            <h3 class="text-lg font-medium text-slate-900">Tu carrito est√° vac√≠o</h3>
                            <p class="text-slate-500 mt-1 max-w-xs">Explora nuestro cat√°logo y a√±ade productos geniales.</p>
                            <button onclick="toggleCart()" class="mt-6 text-brand-600 font-bold hover:underline">Volver a la tienda</button>
                        </div>
                    </div>

                    <!-- Footer Checkout -->
                    <div class="border-t border-slate-100 p-6 bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                        <div class="flex justify-between text-base font-medium text-slate-900 mb-6">
                            <span class="text-lg">Total Final</span>
                            <span id="cart-final-total" class="text-2xl font-extrabold tracking-tight text-brand-600">$0.00</span>
                        </div>
                        
                        <form id="checkout-form" class="space-y-4" onsubmit="processCheckout(event)">
                            <div class="space-y-3">
                                <input type="text" id="customer-name" required class="block w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-brand-500 transition-colors" placeholder="Tu Nombre Completo">
                                <input type="tel" id="customer-phone" required class="block w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-brand-500 transition-colors" placeholder="Tel√©fono de contacto">
                                <textarea id="customer-address" required rows="2" class="block w-full rounded-xl border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:border-brand-500 focus:ring-brand-500 transition-colors resize-none" placeholder="Direcci√≥n de entrega"></textarea>
                            </div>
                            <button type="submit" class="w-full flex items-center justify-center rounded-xl border border-transparent bg-green-600 px-6 py-4 text-base font-bold text-white shadow-lg shadow-green-600/20 hover:bg-green-700 transition-all hover:-translate-y-1">
                                <i data-lucide="message-circle" class="mr-2 h-5 w-5"></i>
                                Enviar Pedido por WhatsApp
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- L√ìGICA DE LA TIENDA -->
    <script>
        // CONFIGURACI√ìN: Lee archivo local 'datos_tienda.csv'
        const CSV_LOCAL_FILE = "./datos_tienda.csv";
        
        let storeConfig = {};
        let products = [];
        let categories = new Set();
        let cart = []; // Array para soportar variantes
        let currentCategory = 'Todos';

        window.onload = function() {
            lucide.createIcons();
            
            Papa.parse(CSV_LOCAL_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.warn("Error cargando CSV local:", err);
                    useDummyData(); 
                }
            });

            // Listener para buscador
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                renderProducts(term);
            });
        };

        function useDummyData() {
            const dummyData = [
                {
                    "Tienda_Nombre": "Tienda Demo", "Tienda_Descripcion": "Cat√°logo Premium", "Tienda_Color_1": "#2563eb", "Tienda_Moneda": "MXN", "Tienda_Prefijo": "52", "Tienda_Telefono": "5512345678",
                    "Prod_Categoria": "Ropa", "Prod_Nombre": "Camiseta Premium", "Prod_Precio": "350.00", "Prod_Imagen": "", "Prod_Descripcion": "Algod√≥n 100% de alta calidad.", 
                    "Var1_Titulo": "Color", "Var1_Opciones": "Negro;Blanco", "Var1_Fotos": "", "Var2_Titulo": "Talla", "Var2_Opciones": "M;L"
                }
            ];
            processData(dummyData);
        }

        function processData(data) {
            if (!data || data.length === 0) return;

            const firstRow = data[0];
            storeConfig = {
                name: firstRow.Tienda_Nombre || "Mi Tienda",
                desc: firstRow.Tienda_Descripcion || "",
                phone: firstRow.Tienda_Telefono || "",
                prefix: firstRow.Tienda_Prefijo || "52",
                currency: firstRow.Tienda_Moneda || "MXN",
                color1: firstRow.Tienda_Color_1 || "#2563eb",
            };

            // Aplicar configuraci√≥n
            document.title = storeConfig.name;
            document.getElementById('store-title').innerText = storeConfig.name;
            if(storeConfig.desc) document.getElementById('store-desc').innerText = storeConfig.desc;
            
            // Configurar color primario en Tailwind din√°micamente (opcional, aqu√≠ usamos el preset brand-600)

            products = data.filter(row => row.Prod_Nombre && row.Prod_Precio).map((row, index) => {
                categories.add(row.Prod_Categoria);
                return {
                    id: index,
                    category: row.Prod_Categoria,
                    name: row.Prod_Nombre,
                    desc: row.Prod_Descripcion,
                    price: parseFloat(row.Prod_Precio.replace(/[^0-9.]/g, '')),
                    image: row.Prod_Imagen,
                    variants: parseVariantsColumns(row)
                };
            });

            renderCategories();
            renderProducts();
            
            // Ocultar loader
            const loader = document.getElementById('loading');
            loader.classList.add('opacity-0');
            setTimeout(() => loader.style.display = 'none', 500);
        }

        function parseVariantsColumns(row) {
            const variants = [];
            
            // Variante 1
            if (row.Var1_Titulo && row.Var1_Opciones) {
                const options = row.Var1_Opciones.split(';').map(s => s.trim());
                const images = row.Var1_Fotos ? row.Var1_Fotos.split(';').map(s => s.trim()) : [];
                variants.push({
                    label: row.Var1_Titulo,
                    options: options.map((opt, i) => ({ name: opt, image: images[i] || null }))
                });
            }

            // Variante 2
            if (row.Var2_Titulo && row.Var2_Opciones) {
                const options = row.Var2_Opciones.split(';').map(s => s.trim());
                variants.push({ label: row.Var2_Titulo, options: options.map(opt => ({ name: opt, image: null })) });
            }

            return variants;
        }

        function renderCategories() {
            const container = document.getElementById('category-container');
            // Bot√≥n "Todos"
            let html = `
                <button onclick="filterCategory('Todos')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 shadow-sm border border-white/20 whitespace-nowrap bg-white text-brand-900 active-cat ring-2 ring-white/50">
                    Todos
                </button>
            `;
            
            categories.forEach(cat => {
                html += `
                    <button onclick="filterCategory('${cat}')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 shadow-sm border border-white/20 whitespace-nowrap bg-white/10 text-white hover:bg-white/20 backdrop-blur-md">
                        ${cat}
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        function filterCategory(cat) {
            currentCategory = cat;
            // Resetear input b√∫squeda
            document.getElementById('search-input').value = '';
            
            renderProducts();
            
            // Actualizar estilos botones
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.innerText === cat) {
                    btn.className = "cat-btn px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 shadow-lg scale-105 border border-white/20 whitespace-nowrap bg-white text-brand-900 ring-2 ring-white/50";
                } else {
                    btn.className = "cat-btn px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 shadow-sm border border-white/20 whitespace-nowrap bg-white/10 text-white hover:bg-white/20 backdrop-blur-md";
                }
            });
        }

        function renderProducts(searchTerm = '') {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            
            let filtered = products;

            // Filtro por categor√≠a
            if (currentCategory !== 'Todos') {
                filtered = filtered.filter(p => p.category === currentCategory);
            }

            // Filtro por b√∫squeda
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.desc.toLowerCase().includes(searchTerm)
                );
            }

            // Mostrar/Ocultar mensaje "sin resultados"
            if (filtered.length === 0) {
                document.getElementById('no-results').classList.remove('hidden');
            } else {
                document.getElementById('no-results').classList.add('hidden');
            }

            filtered.forEach((p, index) => {
                // Generar selectores de variantes
                let variantSelectors = '';
                if (Array.isArray(p.variants) && p.variants.length > 0) {
                    variantSelectors = `<div class="mt-4 space-y-3 bg-slate-50 p-3 rounded-lg border border-slate-100">`;
                    variantSelectors += p.variants.map((v, idx) => `
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">${v.label}</label>
                            <div class="relative">
                                <select id="var-select-${p.id}-${idx}" onchange="changeProductImage(${p.id}, this)" class="block w-full pl-3 pr-8 py-2 text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 appearance-none transition-shadow cursor-pointer">
                                    ${v.options.map(opt => `<option value="${opt.name}" data-img="${opt.image || ''}">${opt.name}</option>`).join('')}
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    variantSelectors += `</div>`;
                }

                const imgPath = p.image ? `images/${p.image}` : 'https://via.placeholder.com/400x400?text=Sin+Imagen';

                // Animaci√≥n escalonada
                const delay = index * 50; 

                const card = document.createElement('div');
                card.className = "group relative bg-white rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden border border-slate-100 flex flex-col animate-fade-in-up";
                card.style.animationDelay = `${delay}ms`;
                
                card.innerHTML = `
                    <!-- Imagen -->
                    <div class="relative h-64 w-full overflow-hidden bg-slate-100">
                        <img id="img-${p.id}" src="${imgPath}" alt="${p.name}" class="w-full h-full object-cover object-center transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/400?text=Imagen+No+Disp'">
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider text-slate-600 shadow-sm border border-slate-100">
                            ${p.category}
                        </div>
                    </div>
                    
                    <!-- Contenido -->
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-slate-800 leading-tight group-hover:text-brand-600 transition-colors">${p.name}</h3>
                            <p class="text-sm text-slate-500 mt-2 line-clamp-2 leading-relaxed">${p.desc}</p>
                            
                            <!-- Variantes -->
                            ${variantSelectors}
                        </div>

                        <!-- Footer Card -->
                        <div class="mt-5 pt-4 border-t border-slate-50 flex items-end justify-between gap-3">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">Precio</span>
                                <span class="text-xl font-extrabold text-slate-900">$${p.price.toLocaleString('es-MX', {minimumFractionDigits: 2})}</span>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <!-- Cantidad Local -->
                                <div class="flex items-center bg-slate-100 rounded-xl h-10 px-1">
                                    <button onclick="adjustInput(${p.id}, -1)" class="w-8 h-full flex items-center justify-center rounded-lg text-slate-400 hover:bg-white hover:text-red-500 hover:shadow-sm transition">
                                        <i data-lucide="minus" class="w-3 h-3"></i>
                                    </button>
                                    <input id="qty-${p.id}" type="number" min="1" value="1" class="w-8 text-center bg-transparent border-none text-sm font-bold text-slate-700 focus:outline-none pointer-events-none">
                                    <button onclick="adjustInput(${p.id}, 1)" class="w-8 h-full flex items-center justify-center rounded-lg text-slate-400 hover:bg-white hover:text-brand-600 hover:shadow-sm transition">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>
                                </div>

                                <button onclick="addToCart(${p.id})" class="bg-slate-900 hover:bg-brand-600 text-white h-10 w-10 rounded-xl flex items-center justify-center shadow-lg transition-all active:scale-90 group-btn">
                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        function adjustInput(id, change) {
            const input = document.getElementById(`qty-${id}`);
            let val = parseInt(input.value) + change;
            if(val < 1) val = 1;
            input.value = val;
        }

        window.changeProductImage = function(id, select) {
            const selectedOption = select.options[select.selectedIndex];
            const newImg = selectedOption.getAttribute('data-img');
            if (newImg && newImg !== '') {
                const imgEl = document.getElementById(`img-${id}`);
                imgEl.style.opacity = '0'; // Efecto suave
                setTimeout(() => {
                    imgEl.src = `images/${newImg}`;
                    imgEl.onload = () => imgEl.style.opacity = '1';
                }, 150);
            }
        };

        window.addToCart = function(id) {
            const product = products.find(p => p.id === id);
            const qty = parseInt(document.getElementById(`qty-${id}`).value);
            
            // Recolectar variantes
            let selectedVariants = [];
            if (Array.isArray(product.variants)) {
                product.variants.forEach((v, idx) => {
                    const select = document.getElementById(`var-select-${id}-${idx}`);
                    selectedVariants.push(`${v.label}: ${select.value}`);
                });
            }
            const variantString = selectedVariants.join(', ');

            // L√≥gica para agrupar items id√©nticos (mismo ID + mismas variantes)
            const existingItem = cart.find(item => item.id === id && item.variant === variantString);

            if (existingItem) {
                existingItem.qty += qty;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    image: product.image,
                    variant: variantString,
                    qty: qty
                });
            }

            // Reset input
            document.getElementById(`qty-${id}`).value = 1;

            updateCartUI();
            showToast(`${qty}x ${product.name} agregado`);
        };

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartUI();
        };

        window.updateQty = function(index, change) {
            const item = cart[index];
            item.qty += change;
            if(item.qty < 1) {
                removeFromCart(index);
            } else {
                updateCartUI();
            }
        }

        function updateCartUI() {
            // Totales
            const totalQty = cart.reduce((acc, item) => acc + item.qty, 0);
            const totalAmount = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
            const formattedTotal = `$${totalAmount.toLocaleString('es-MX', {minimumFractionDigits: 2})} ${storeConfig.currency}`;

            // Badges y Barra
            const badge = document.getElementById('header-cart-count');
            const stickyBar = document.getElementById('sticky-cart-bar');
            
            badge.innerText = totalQty;
            document.getElementById('sticky-total').innerText = formattedTotal;
            document.getElementById('cart-final-total').innerText = formattedTotal;

            if (totalQty > 0) {
                badge.classList.remove('scale-0');
                stickyBar.classList.remove('translate-y-full');
            } else {
                badge.classList.add('scale-0');
                stickyBar.classList.add('translate-y-full');
            }

            // Renderizar items en Drawer
            const cartContainer = document.getElementById('cart-items-container');
            const emptyMsg = document.getElementById('empty-cart-msg');
            
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                
                cart.forEach((item, index) => {
                    const imgPath = item.image ? `images/${item.image}` : 'https://via.placeholder.com/100';
                    const subtotal = item.price * item.qty;

                    const row = document.createElement('div');
                    row.className = "flex gap-4 p-3 bg-white rounded-2xl border border-slate-100 shadow-sm transition hover:border-brand-200";
                    row.innerHTML = `
                        <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-xl border border-slate-100 bg-slate-50">
                            <img src="${imgPath}" alt="${item.name}" class="h-full w-full object-cover object-center">
                        </div>
                        <div class="flex flex-1 flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start">
                                    <h3 class="text-sm font-bold text-slate-800 line-clamp-1">${item.name}</h3>
                                    <p class="ml-2 text-sm font-bold text-brand-600">$${subtotal.toLocaleString('es-MX')}</p>
                                </div>
                                ${item.variant ? `<p class="mt-1 text-xs text-slate-500 bg-slate-50 inline-block px-1.5 py-0.5 rounded border border-slate-100">${item.variant}</p>` : ''}
                            </div>
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex items-center bg-slate-50 rounded-lg p-0.5 border border-slate-200">
                                    <button onclick="updateQty(${index}, -1)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white text-slate-400 shadow-sm hover:text-red-500 transition">
                                        <i data-lucide="minus" class="w-3 h-3"></i>
                                    </button>
                                    <span class="w-8 text-center text-xs font-bold text-slate-700">${item.qty}</span>
                                    <button onclick="updateQty(${index}, 1)" class="w-6 h-6 flex items-center justify-center rounded-md bg-white text-slate-400 shadow-sm hover:text-green-600 transition">
                                        <i data-lucide="plus" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <button onclick="removeFromCart(${index})" class="text-xs text-red-500 hover:text-red-700 font-medium underline decoration-red-200 hover:decoration-red-500 underline-offset-2">Eliminar</button>
                            </div>
                        </div>
                    `;
                    cartContainer.appendChild(row);
                });
            }
            lucide.createIcons();
        }

        window.toggleCart = function() {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            const backdrop = document.getElementById('cart-backdrop');
            
            if (modal.classList.contains('hidden')) {
                // Abrir
                updateCartUI();
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Animaciones
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                }, 10);
            } else {
                // Cerrar
                backdrop.classList.add('opacity-0');
                panel.classList.add('translate-x-full');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }, 300);
            }
        };

        window.processCheckout = function(e) {
            e.preventDefault();
            if (cart.length === 0) {
                showToast("El carrito est√° vac√≠o üòî");
                return;
            }

            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const address = document.getElementById('customer-address').value;

            if(!name || !phone || !address) {
                alert("Por favor completa todos los campos de env√≠o");
                return;
            }

            let message = `*PEDIDO WEB - ${storeConfig.name}*\n--------------------------------\n`;
            message += `üë§ *Cliente:* ${name}\n`;
            message += `üìû *Tel√©fono:* ${phone}\n`;
            message += `üìç *Direcci√≥n:* ${address}\n\n`;
            message += `*DETALLE DEL PEDIDO:*\n`;
            
            let total = 0;
            cart.forEach(item => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                message += `üì¶ ${item.qty}x ${item.name}\n`;
                if(item.variant) message += `   ‚Ü≥ ${item.variant}\n`;
                message += `   $${subtotal.toLocaleString('es-MX')}\n`;
            });

            message += `\nüí∞ *TOTAL: $ ${total.toLocaleString('es-MX', {minimumFractionDigits: 2})} ${storeConfig.currency}*`;

            const encodedMsg = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${storeConfig.prefix}${storeConfig.phone}?text=${encodedMsg}`;
            
            window.open(whatsappUrl, '_blank');
        };
    </script>
</body>
</html>
